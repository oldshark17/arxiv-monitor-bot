# 🤖 ArXiv Monitor Bot

Телеграм-бот для мониторинга научных статей с ArXiv.org с AI-суммаризацией на русском языке.

## ✨ Возможности

- 🔍 **Умный поиск** — поиск по названию и аннотации статей (не в метаданных)
- 📄 **Пагинация** — навигация вперёд/назад, корректная нумерация статей
- 📬 **Подписки** — ежедневные уведомления о новых статьях (после 06:00)
- 🧠 **AI-суммаризация** — экспертный пересказ на русском через Gemini
- 📖 **Telegraph страницы** — красивое форматирование с HTML-тегами

---

## 🏗 Архитектура

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────┐
│  Telegram Bot   │────▶│   arXiv API  │────▶│   Gemini    │
│   (aiogram 3)   │     │  (официальный)│     │   2.5 Flash │
└────────┬────────┘     └──────────────┘     └─────────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────┐
│    SQLite DB    │     │   Telegraph  │
│  (подписки)     │     │   (страницы) │
└─────────────────┘     └──────────────┘
```

---

## 🛠 Технологии

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| Telegram бот | `aiogram 3.x` | Async фреймворк для ботов |
| База данных | `SQLite3` | Хранение подписок и seen papers |
| Поиск статей | `arxiv` (PyPI) | Официальный API arXiv |
| AI суммаризация | `google-genai` | Gemini 2.5 Flash |
| Публикация | `telegraph` | Создание страниц с контентом |
| Планировщик | `APScheduler` | Фоновые задачи мониторинга |

---

## 📊 База данных (SQLite)

```sql
-- Пользователи
users (user_id, created_at)

-- Подписки на темы
subscriptions (id, user_id, topic, frequency, last_checked, created_at)

-- Отправленные статьи (чтобы не дублировать)
seen_papers (id, user_id, subscription_id, arxiv_id, sent_at)
```

**Файл:** `src/arxiv_bot.db`

---

## 🤖 LLM Промпты

### Краткое содержание статьи
```
Ты эксперт-ученый. Переведи на русский и сделай краткий пересказ статьи '{title}'.
Используй HTML-теги <b>, <i>, <ul>, <li>. Опиши суть, методы и результат.
Абстракт статьи: {abstract}
```

**Модель:** `gemini-2.5-flash`

**Форматирование Telegraph:**
- Заголовок статьи (`<h4>`)
- Горизонтальная линия (`<hr>`)
- AI-пересказ с HTML-форматированием
- Ссылка на оригинал arXiv

---

## 📅 Мониторинг подписок

### Расписание arXiv
- **Обновления:** ВС-ЧТ в ~20:00 ET (~06:00 UTC+5)
- **Нет обновлений:** ПТ, СБ

### Логика проверки
```python
# Планировщик запускается каждый час в :00
scheduler.add_job(check_subscriptions, 'cron', minute=0)

# Пропускаем ПТ/СБ (arXiv не обновляется)
if now.weekday() in {4, 5}:
    return

# Проверяем только после 06:00 (когда статьи уже опубликованы)
if now.hour < 6:
    return

# Для каждой подписки: проверяем один раз в день
if last_checked.date() == now.date():
    continue  # Уже проверяли сегодня
```

**Улучшение:** Вместо проверки "прошло ли 24 часа" теперь проверяется "проверяли ли сегодня". Это гарантирует уведомление каждое утро после 06:00, а не через 24 часа от последней проверки.

---

## 🔍 Поиск и пагинация

### Улучшенный поиск
```python
# Поиск в названии и аннотации (не в метаданных)
formatted_query = f"ti:{query} OR abs:{query}"
```

**Почему так:** Поиск только по `query` находит статьи, где термин упоминается в категориях, именах авторов и т.д. Например, "ASR" найдёт статьи про "Attack Success Rate", хотя вы искали "Automatic Speech Recognition".

### Пагинация с генератором
```python
# Используем offset для позиционирования
results_generator = arxiv_client.results(search, offset=offset)

# Статьи хранятся глобально по arxiv_id
articles_storage[arxiv_id] = article

# Кнопки ссылаются на arxiv_id, не на индекс
callback_data=f"article_{art['arxiv_id']}"
```

**Навигация:**
- ◀️ Назад — возврат на 5 статей
- ▶️ Вперёд — следующие 5 статей
- Все изменения происходят в одном сообщении (edit_message)

---

## 📂 Структура проекта

```
arxiv-monitor-bot/
├── src/
│   ├── main.py          # Основная логика бота
│   ├── database.py      # Работа с SQLite
│   └── arxiv_bot.db     # База данных (создаётся автоматически)
├── requirements.txt     # Зависимости
├── .env                 # Токены (не в git)
└── README.md
```

---

## 🚀 Запуск

```bash
# 1. Клонировать
git clone https://github.com/oldshark17/arxiv-monitor-bot.git
cd arxiv-monitor-bot

# 2. Виртуальное окружение
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 3. Настроить .env
echo "TELEGRAM_TOKEN=ваш_токен" > .env
echo "GEMINI_API_KEY=ваш_ключ" >> .env

# 4. Запустить
python src/main.py
```

---

## 🧪 Тестирование

- `/start` — главное меню
- `/test` — ручной запуск проверки подписок (игнорирует расписание)

---

## 📝 Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Главное меню (поиск / подписки) |
| `/test` | Принудительная проверка подписок |

---

## 🔄 Последние улучшения

### ✅ Исправлена пагинация (2026-01-26)
- **Проблема:** После "Загрузить ещё" статьи нумеровались 1-5 заново, кнопки открывали первые статьи
- **Решение:**
  - Offset-based генератор с `arxiv_client.results(search, offset=offset)`
  - Глобальное хранилище статей по `arxiv_id`
  - Корректная нумерация: 1-5, 6-10, 11-15...
  - Кнопки навигации редактируют существующее сообщение

### ✅ Исправлено расписание подписок (2026-01-26)
- **Проблема:** Уведомления не приходили утром, т.к. требовалось ровно 24 часа с последней проверки
- **Решение:** Проверка `last_checked.date() == now.date()` вместо `hours_since_last < 24`
- **Результат:** Гарантированное уведомление каждое утро после 06:00

### ✅ Улучшен поиск (2026-01-26)
- **Проблема:** Поиск "ASR" находил статьи про "Attack Success Rate", а не "Automatic Speech Recognition"
- **Решение:** Запрос `ti:ASR OR abs:ASR` вместо просто `ASR`
- **Результат:** Поиск только в названиях и аннотациях (не в метаданных)

### ✅ Улучшены Telegraph страницы (2026-01-26)
- **Обновлён промпт:** "Ты эксперт-ученый" вместо "научный ассистент"
- **HTML-форматирование:** Gemini использует `<b>`, `<i>`, `<ul>`, `<li>`
- **Чистка вывода:** Удаление markdown code blocks (` ```html`)
- **Структура:** Заголовок → HR → Пересказ → Ссылка на arXiv
